{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold text-center mb-6 text-white">Registrar Reparación</h1>

    <!-- Formulario de Reparación -->
    <form class="bg-gray-800 shadow-md rounded-xl px-8 pt-6 pb-8 mb-8" method="POST" action="{{ url_for('reparaciones') }}">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
            <i data-lucide="clipboard-edit" class="w-6 h-6"></i> Registrar Reparación
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    
            <!-- Tipo de Reparación -->
            <div>
                <label for="tipo_reparacion" class="text-sm font-semibold text-gray-300 flex items-center gap-2 mb-1">
                    <i data-lucide="wrench" class="w-4 h-4"></i> Tipo de Reparación
                </label>
                <select id="tipo_reparacion" name="tipo_reparacion" class="w-full rounded-lg bg-gray-700 text-gray-300 border border-gray-600 py-2 px-3 focus:outline-none">
                    <option value="modulo">Módulo</option>
                    <option value="pin de carga">Pin de Carga</option>
                    <option value="Tratamiento humedad">Tratamiento humedad</option>
                    <option value="glass">Glass</option>
                    <option value="Soft">Soft</option>
                    <option value="otros">Batería</option>
                    <option value="otros">Otros</option>
                </select>
            </div>
    
            <!-- Equipo -->
            <div>
                <label for="equipo" class="text-sm font-semibold text-gray-300 flex items-center gap-2 mb-1">
                    <i data-lucide="smartphone" class="w-4 h-4"></i> Equipo
                </label>
                <select id="equipo" name="equipo" class="w-full rounded-lg bg-gray-700 text-gray-300 border border-gray-600 py-2 px-3 focus:outline-none">
                    <option value="alcatel">Alcatel</option>
                    <option value="huawei">Huawei</option>
                    <option value="iphone">iPhone</option>
                    <option value="lg">LG</option>
                    <option value="motorola">Motorola</option>
                    <option value="nokia">Nokia</option>
                    <option value="samsung">Samsung</option>
                    <option value="tcl">TCL</option>
                    <option value="xiaomi">Xiaomi</option>                    
                </select>
            </div>
    
            <!-- Modelo -->
            <div>
                <label for="modelo" class="text-sm font-semibold text-gray-300 flex items-center gap-2 mb-1">
                    <i data-lucide="type" class="w-4 h-4"></i> Modelo
                </label>
                <input type="text" id="modelo" name="modelo" placeholder="Ingrese el modelo" class="w-full rounded-lg bg-gray-700 text-white border border-gray-600 py-2 px-3 focus:outline-none">
            </div>
    
            <!-- Técnico -->
            <div>
                <label for="tecnico" class="text-sm font-semibold text-gray-300 flex items-center gap-2 mb-1">
                    <i data-lucide="user-cog" class="w-4 h-4"></i> Técnico
                </label>
                <select id="tecnico" name="tecnico" class="w-full rounded-lg bg-gray-700 text-gray-300 border border-gray-600 py-2 px-3 focus:outline-none">
                    <option value="pablo">Pablo</option>
                    <option value="lucas">Lucas</option>
                    <option value="Jose Maria">Jose Maria</option>
                    <option value="otro">Otro</option>
                </select>
            </div>
    
            <!-- Monto -->
            <div>
                <label for="monto" class="text-sm font-semibold text-gray-300 flex items-center gap-2 mb-1">
                    <i data-lucide="dollar-sign" class="w-4 h-4"></i> Monto
                </label>
                <input type="number" id="monto" name="monto" placeholder="Ingrese el monto" class="w-full rounded-lg bg-gray-700 text-white border border-gray-600 py-2 px-3 focus:outline-none">
            </div>
    
            <!-- Nombre del Cliente -->
            <div>
                <label for="nombre_cliente" class="text-sm font-semibold text-gray-300 flex items-center gap-2 mb-1">
                    <i data-lucide="user" class="w-4 h-4"></i> Nombre del Cliente
                </label>
                <input type="text" id="nombre_cliente" name="nombre_cliente" placeholder="Ingrese el nombre del cliente" class="w-full rounded-lg bg-gray-700 text-white border border-gray-600 py-2 px-3 focus:outline-none">
            </div>
    
            <!-- Teléfono -->
            <div>
                <label for="telefono" class="text-sm font-semibold text-gray-300 flex items-center gap-2 mb-1">
                    <i data-lucide="phone" class="w-4 h-4"></i> Número de Teléfono
                </label>
                <input type="tel" id="telefono" name="telefono" placeholder="Ingrese el número de teléfono" class="w-full rounded-lg bg-gray-700 text-white border border-gray-600 py-2 px-3 focus:outline-none">
            </div>
    
            <!-- Número de Orden -->
            <div>
                <label for="nro_orden" class="text-sm font-semibold text-gray-300 flex items-center gap-2 mb-1">
                    <i data-lucide="hash" class="w-4 h-4"></i> Número de Orden
                </label>
                <input type="text" id="nro_orden" name="nro_orden" placeholder="Ingrese el número de orden" class="w-full rounded-lg bg-gray-700 text-white border border-gray-600 py-2 px-3 focus:outline-none">
            </div>
        </div>
    
        <!-- Botón de Enviar -->
        <div class="mt-8">
            <button type="submit" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition duration-300">
                <i data-lucide="save" class="w-5 h-5"></i> Registrar Reparación
            </button>
        </div>
    </form>
    

        <!-- Filtro de Fecha -->
        <div class="bg-gray-800 shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <h2 class="text-xl font-bold text-center mb-6 text-white">Filtrar por Fecha</h2>
            <form method="GET" action="{{ url_for('reparaciones') }}" class="flex flex-wrap justify-center gap-4">
                <div>
                    <label class="block text-gray-300 text-sm font-bold mb-2" for="fecha_desde">
                        Desde
                    </label>
                    <input type="date" id="fecha_desde" name="fecha_desde" class="shadow appearance-none border rounded py-2 px-3 bg-gray-700 text-gray-300 leading-tight focus:outline-none focus:shadow-outline" value="{{ fecha_desde }}">
                </div>
                <div>
                    <label class="block text-gray-300 text-sm font-bold mb-2" for="fecha_hasta">
                        Hasta
                    </label>
                    <input type="date" id="fecha_hasta" name="fecha_hasta" class="shadow appearance-none border rounded py-2 px-3 bg-gray-700 text-gray-300 leading-tight focus:outline-none focus:shadow-outline" value="{{ fecha_hasta }}">
                </div>
                <div class="flex items-end">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Filtrar
                    </button>
                </div>
            </form>
        </div>

        <!-- Resumen de Equipos por Técnico -->
        <!-- Resumen de Equipos por Técnico -->
        <div class="bg-gray-800 shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <h2 class="text-xl font-bold text-center mb-6 text-white">Equipos por Técnico</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for tecnico, cantidad in equipos_por_tecnico.items() %}
                <div class="bg-gray-700 p-4 rounded-lg flex items-center gap-4">
                    <i data-lucide="user-cog" class="text-cyan-400 w-6 h-6"></i>
                    <div>
                        <h3 class="text-lg font-bold text-white">{{ tecnico }}</h3>
                        <p class="text-gray-300">Equipos asignados: {{ cantidad }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Resumen de Equipos por Estado -->
<div class="bg-gray-800 shadow-md rounded px-8 pt-6 pb-8 mb-4">
    <h2 class="text-xl font-bold text-center mb-6 text-white">Resumen por Estado</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="bg-gray-700 p-4 rounded-lg flex items-center gap-4">
            <i data-lucide="wrench" class="text-yellow-400 w-6 h-6"></i>
            <div>
                <h3 class="text-lg font-semibold text-white">Por Reparar</h3>
                <p class="text-gray-300">Cantidad: {{ estados.por_reparar }}</p>
            </div>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg flex items-center gap-4">
            <i data-lucide="settings" class="text-blue-400 w-6 h-6"></i>
            <div>
                <h3 class="text-lg font-semibold text-white">En Reparación</h3>
                <p class="text-gray-300">Cantidad: {{ estados.en_reparacion }}</p>
            </div>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg flex items-center gap-4">
            <i data-lucide="check-circle" class="text-green-400 w-6 h-6"></i>
            <div>
                <h3 class="text-lg font-semibold text-white">Listo</h3>
                <p class="text-gray-300">Cantidad: {{ estados.listo }}</p>
            </div>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg flex items-center gap-4">
            <i data-lucide="truck" class="text-purple-400 w-6 h-6"></i>
            <div>
                <h3 class="text-lg font-semibold text-white">Retirado</h3>
                <p class="text-gray-300">Cantidad: {{ estados.retirado }}</p>
            </div>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg flex items-center gap-4">
            <i data-lucide="database" class="text-teal-400 w-6 h-6"></i>
            <div>
                <h3 class="text-lg font-semibold text-white">Total Equipos</h3>
                <p class="text-gray-300">Cantidad: {{ estados.total }}</p>
            </div>
        </div>
    </div>
</div>


        <!-- Últimos Teléfonos Cargados -->
        <div class="bg-gray-800 shadow-md rounded px-4 md:px-8 pt-6 pb-8 mb-4">
            <h2 class="text-xl font-bold text-center mb-6 text-white">Últimos Teléfonos Cargados</h2>
        
            <!-- Vista tipo tarjeta para móviles -->
            <div class="md:hidden space-y-4">
                {% for equipo in ultimos_equipos %}
                    <div class="bg-gray-700 p-4 rounded-lg shadow">
                        <p><strong>Tipo Reparación:</strong> {{ equipo.tipo_reparacion }}</p>
                        <p><strong>Marca:</strong> {{ equipo.marca }}</p>
                        <p><strong>Modelo:</strong> {{ equipo.modelo }}</p>
                        <p><strong>Técnico:</strong> {{ equipo.tecnico }}</p>
                        <p><strong>Monto:</strong> {{ equipo.monto }}</p>
                        <p><strong>Cliente:</strong> {{ equipo.nombre_cliente }}</p>
                        <p><strong>Teléfono:</strong> {{ equipo.telefono }}</p>
                        <p><strong>N° Orden:</strong> {{ equipo.nro_orden }}</p>
                        <p><strong>Fecha:</strong> {{ equipo.fecha }}</p>
                        <div class="mb-2">
                            <label class="block text-sm font-semibold mb-1">Estado:</label>
                            <select class="estado-reparacion w-full bg-gray-800 text-white p-2 rounded" data-telefono="{{ equipo.telefono }}" data-nro-orden="{{ equipo.nro_orden }}">
                                <option value="por_reparar" {% if equipo.estado == 'por_reparar' %}selected{% endif %}>Por reparar</option>
                                <option value="en_reparacion" {% if equipo.estado == 'en_reparacion' %}selected{% endif %}>En reparación</option>
                                <option value="listo" {% if equipo.estado == 'listo' %}selected{% endif %}>Listo</option>
                                <option value="Retirado" {% if equipo.estado == 'Retirado' %}selected{% endif %}>Retirado</option>
                                <option value="No salio" {% if equipo.estado == 'No salio' %}selected{% endif %}>No salió</option>
                            </select>
                        </div>
                        <form action="{{ url_for('eliminar_reparacion', id=equipo.id) }}" method="POST" onsubmit="return confirm('¿Estás seguro de que deseas eliminar este equipo?');">
                            <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded mt-2">
                                Eliminar
                            </button>
                        </form>
                    </div>
                {% endfor %}
            </div>
        
            <!-- Tabla visible en pantallas medianas o grandes -->
            <div class="hidden md:block overflow-x-auto">
                <table class="min-w-full bg-gray-700 text-gray-300">
                    <thead>
                        <tr>
                            <th class="px-4 py-2">Tipo Reparación</th>
                            <th class="px-4 py-2">Marca</th>
                            <th class="px-4 py-2">Modelo</th>
                            <th class="px-4 py-2">Técnico</th>
                            <th class="px-4 py-2">Monto</th>
                            <th class="px-4 py-2">Cliente</th>
                            <th class="px-4 py-2">Teléfono</th>
                            <th class="px-4 py-2">N° Orden</th>
                            <th class="px-4 py-2">Fecha</th>
                            <th class="px-4 py-2">Estado</th>
                            <th class="px-4 py-2">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for equipo in ultimos_equipos %}
                            <tr>
                                <td class="border px-4 py-2">{{ equipo.tipo_reparacion }}</td>
                                <td class="border px-4 py-2">{{ equipo.marca }}</td>
                                <td class="border px-4 py-2">{{ equipo.modelo }}</td>
                                <td class="border px-4 py-2">{{ equipo.tecnico }}</td>
                                <td class="border px-4 py-2">{{ equipo.monto }}</td>
                                <td class="border px-4 py-2">{{ equipo.nombre_cliente }}</td>
                                <td class="border px-4 py-2">{{ equipo.telefono }}</td>
                                <td class="border px-4 py-2">{{ equipo.nro_orden }}</td>
                                <td class="border px-4 py-2">{{ equipo.fecha }}</td>
                                <td class="border px-4 py-2">
                                    <select class="estado-reparacion bg-gray-700 text-gray-300 rounded" data-telefono="{{ equipo.telefono }}" data-nro-orden="{{ equipo.nro_orden }}">
                                        <option value="por_reparar" {% if equipo.estado == 'por_reparar' %}selected{% endif %}>Por reparar</option>
                                        <option value="en_reparacion" {% if equipo.estado == 'en_reparacion' %}selected{% endif %}>En reparación</option>
                                        <option value="listo" {% if equipo.estado == 'listo' %}selected{% endif %}>Listo</option>
                                        <option value="Retirado" {% if equipo.estado == 'Retirado' %}selected{% endif %}>Retirado</option>
                                        <option value="No salio" {% if equipo.estado == 'No salio' %}selected{% endif %}>No salió</option>
                                    </select>
                                </td>
                                <td class="border px-4 py-2">
                                    <form action="{{ url_for('eliminar_reparacion', id=equipo.id) }}" method="POST" onsubmit="return confirm('¿Estás seguro de que deseas eliminar este equipo?');">
                                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">
                                            Eliminar
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>

    <!-- Script para manejar el cambio de estado y enviar WhatsApp -->
    <script>
        document.querySelectorAll('.estado-reparacion').forEach(select => {
            select.addEventListener('change', function() {
                const estado = this.value;
                const telefono = this.getAttribute('data-telefono');
                const nroOrden = this.getAttribute('data-nro-orden');

                if (estado === 'listo') {
                    // Mensaje de WhatsApp
                    const mensaje = `Hola, Nos comunicamos de Servicell tu equipo con número de orden ${nroOrden} está listo para ser retirado. ¡Gracias por confiar en nosotros!`;
                    const urlWhatsApp = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;

                    // Abrir WhatsApp en una nueva pestaña
                    window.open(urlWhatsApp, '_blank');
                }

                // Aquí puedes agregar una llamada a tu backend para actualizar el estado en la base de datos
                fetch('/actualizar_estado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nro_orden: nroOrden,
                        estado: estado
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Estado actualizado:', data);
                })
                .catch(error => {
                    console.error('Error al actualizar el estado:', error);
                });
            });
        });
    </script>
{% endblock %}

